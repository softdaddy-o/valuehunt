#!/usr/bin/env node

/**
 * Terraform Setup Helper
 *
 * Automatically generates terraform.tfvars from your .env file
 * Syncs secrets to GitHub Actions
 */

import fs from 'fs';
import path from 'path';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const ROOT_DIR = path.join(__dirname, '..');
const ENV_FILE = path.join(ROOT_DIR, 'frontend', '.env');
const TFVARS_FILE = path.join(ROOT_DIR, 'terraform', 'terraform.tfvars');

function exitWithError(message, details) {
  console.error(`Error: ${message}`);
  if (details) {
    console.error(`   ${details}`);
  }
  process.exit(1);
}

console.log('ValueHunt Terraform Setup\n');

if (!fs.existsSync(ENV_FILE)) {
  exitWithError('frontend/.env file not found', 'Please create .env from .env.example first');
}

function parseEnvFile(filePath) {
  const content = fs.readFileSync(filePath, 'utf-8');
  const secrets = {};
  const placeholderPatterns = ['your-', 'your_', 'YOUR_', 'YOUR-'];

  for (const line of content.split('\n')) {
    const trimmed = line.trim();

    if (!trimmed || trimmed.startsWith('#')) {
      continue;
    }

    const match = trimmed.match(/^([^=]+)=(.*)$/);
    if (!match) {
      continue;
    }

    const key = match[1].trim();
    let value = match[2].trim();

    // Remove surrounding quotes
    if ((value.startsWith('"') && value.endsWith('"')) ||
        (value.startsWith("'") && value.endsWith("'"))) {
      value = value.slice(1, -1);
    }

    // Skip placeholder values and empty values
    const isPlaceholder = (
      value === '' ||
      value === 'your-api-key-here' ||
      value.startsWith('your-') ||
      value.startsWith('your_') ||
      value.startsWith('YOUR_') ||
      value.startsWith('YOUR-')
    );

    if (value && !isPlaceholder) {
      secrets[key] = value;
    }
  }

  return secrets;
}

function getGitHubToken() {
  try {
    const token = execSync('gh auth token', { encoding: 'utf-8', stdio: ['pipe', 'pipe', 'pipe'] }).trim();
    console.log('Found GitHub token from gh CLI');
    return token;
  } catch {
    console.warn('Warning: Could not get GitHub token from gh CLI');
    console.warn('   You will need to add it manually to terraform.tfvars');
    return 'ghp_your_github_token_here';
  }
}

const githubToken = getGitHubToken();

console.log('Reading secrets from frontend/.env file...');
const secrets = parseEnvFile(ENV_FILE);
const secretCount = Object.keys(secrets).length;

if (secretCount === 0) {
  exitWithError('No valid secrets found in .env file', 'Check that frontend/.env contains non-placeholder values');
}

console.log(`Found ${secretCount} secrets\n`);

function generateTfvars(token, secretsMap) {
  const secretsBlock = Object.entries(secretsMap)
    .map(([key, value]) => `  ${key} = "${value.replace(/"/g, '\\"')}"`)
    .join('\n');

  return `# ValueHunt Terraform Configuration
# Auto-generated by setup-terraform.js
# DO NOT COMMIT THIS FILE

github_token      = "${token}"
github_owner      = "softdaddy-o"
github_repository = "valuehunt"

secrets = {
${secretsBlock}
}
`;
}

const tfvarsContent = generateTfvars(githubToken, secrets);
fs.writeFileSync(TFVARS_FILE, tfvarsContent);

console.log('Generated terraform.tfvars\n');
console.log('Next steps:');
console.log('   1. cd terraform');
console.log('   2. terraform init');
console.log('   3. terraform apply\n');
console.log(`File location: ${TFVARS_FILE}`);
